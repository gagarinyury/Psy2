<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Patient Console</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-6 max-w-6xl">
        <h1 class="text-3xl font-bold mb-8 text-center text-blue-600">RAG Patient Test Console</h1>

        <!-- Case Panel -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">üìÑ Case Management</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Case JSON:</label>
                    <textarea id="case-json" class="w-full h-32 border rounded p-3 font-mono text-sm"
                              placeholder='Paste case JSON here or click "Load Demo"'></textarea>
                    <div class="flex gap-2 mt-2">
                        <button onclick="loadDemoCase()"
                                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            Load Demo
                        </button>
                        <button onclick="loadCase()"
                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            Load Case
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Result:</label>
                    <div id="case-result" class="bg-gray-50 border rounded p-3 h-32 overflow-auto text-sm font-mono"></div>
                </div>
            </div>
        </div>

        <!-- Session Panel -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">üéØ Session Management</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Case ID:</label>
                    <input id="session-case-id" type="text" readonly
                           class="w-full border rounded p-3 bg-gray-50 text-sm font-mono mb-4"
                           placeholder="Load a case first">
                    <button onclick="startSession()"
                            class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        Start Session
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Result:</label>
                    <div id="session-result" class="bg-gray-50 border rounded p-3 h-24 overflow-auto text-sm font-mono"></div>
                </div>
            </div>
        </div>

        <!-- Turn Panel -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">üí¨ Turn Processing</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Session ID:</label>
                        <input id="turn-session-id" type="text" readonly
                               class="w-full border rounded p-3 bg-gray-50 text-sm font-mono"
                               placeholder="Start a session first">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">User Message:</label>
                        <textarea id="turn-utterance" class="w-full h-20 border rounded p-3"
                                  placeholder="Enter user message here"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trust Level: <span id="trust-value">0.3</span></label>
                        <input id="trust-slider" type="range" min="0" max="1" step="0.1" value="0.3"
                               class="w-full" oninput="updateTrustDisplay(this.value)">
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="turnWithMode(false)"
                                class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                            Turn (metadata)
                        </button>
                        <button onclick="turnWithMode(true)"
                                class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                            Turn (vector)
                        </button>
                        <button onclick="riskCheck()"
                                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            Risk Check
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Result:</label>
                    <div id="turn-result" class="bg-gray-50 border rounded p-3 h-64 overflow-auto text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Report Panel -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">üìä Session Report</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Session ID:</label>
                    <input id="report-session-id" type="text" readonly
                           class="w-full border rounded p-3 bg-gray-50 text-sm font-mono mb-4"
                           placeholder="Start a session first">
                    <button onclick="getSessionReport()"
                            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Session Report
                    </button>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Report:</label>
                    <div id="report-result" class="bg-gray-50 border rounded p-3 h-32 overflow-auto text-sm"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state management
        let caseId = localStorage.getItem('console_case_id') || '';
        let sessionId = localStorage.getItem('console_session_id') || '';

        // Initialize UI
        document.addEventListener('DOMContentLoaded', function() {
            if (caseId) {
                document.getElementById('session-case-id').value = caseId;
            }
            if (sessionId) {
                document.getElementById('turn-session-id').value = sessionId;
                document.getElementById('report-session-id').value = sessionId;
            }
        });

        function loadDemoCase() {
            const demoCase = {
                "case_truth": {
                    "dx_target": ["MDD"],
                    "ddx": {"MDD": 0.6, "GAD": 0.3, "AUD": 0.1},
                    "hidden_facts": ["—ç–ø–∏–∑–æ–¥ –≤ 2016", "—Å–µ–º–µ–π–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–µ–ø—Ä–µ—Å—Å–∏–∏"],
                    "red_flags": ["—Å—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã–µ –º—ã—Å–ª–∏"],
                    "trajectories": [{
                        "id": "traj1",
                        "name": "—É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ",
                        "steps": [
                            {"id": "step1", "name": "—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–≤–µ—Ä–∏—è", "condition_tags": [], "min_trust": 0.3},
                            {"id": "step2", "name": "–≤—ã—è–≤–ª–µ–Ω–∏–µ —Å–∏–º–ø—Ç–æ–º–æ–≤", "condition_tags": ["symptoms"], "min_trust": 0.5},
                            {"id": "step3", "name": "—Ä–∞–±–æ—Ç–∞ —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é", "condition_tags": ["risk"], "min_trust": 0.7}
                        ]
                    }]
                },
                "policies": {
                    "disclosure_rules": {
                        "full_on_valid_question": true,
                        "partial_if_low_trust": true,
                        "min_trust_for_gated": 0.4
                    },
                    "distortion_rules": {
                        "enabled": true,
                        "by_defense": {}
                    },
                    "risk_protocol": {
                        "trigger_keywords": ["—Å—É–∏—Ü–∏–¥", "—É–±–∏—Ç—å —Å–µ–±—è", "–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å"],
                        "response_style": "stable",
                        "lock_topics": []
                    },
                    "style_profile": {
                        "register": "colloquial",
                        "tempo": "medium",
                        "length": "short"
                    }
                },
                "kb": [
                    {
                        "id": "kb1",
                        "type": "bio",
                        "text": "–†–æ–¥–∏–ª—Å—è –≤ 1989, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ò–¢.",
                        "metadata": {
                            "topic": "background",
                            "tags": ["—Ä–∞–±–æ—Ç–∞","—Å–µ–º—å—è"],
                            "emotion_label": "neutral",
                            "availability": "public",
                            "disclosure_cost": 0,
                            "consistency_keys": ["birth_year:1989"]
                        }
                    },
                    {
                        "id": "kb2",
                        "type": "symptom",
                        "text": "–ù–∞—Ä—É—à–µ–Ω–∏–µ —Å–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞.",
                        "metadata": {
                            "topic": "sleep",
                            "tags": ["insomnia"],
                            "emotion_label": "sad",
                            "availability": "gated",
                            "disclosure_cost": 2,
                            "disclosure_requirements": {"trust_ge": 0.4},
                            "consistency_keys": ["symptom:sleep"]
                        }
                    }
                ]
            };
            document.getElementById('case-json').value = JSON.stringify(demoCase, null, 2);
        }

        async function loadCase() {
            const caseJson = document.getElementById('case-json').value;
            if (!caseJson.trim()) {
                document.getElementById('case-result').innerHTML =
                    '<span class="text-red-600">Enter case JSON first</span>';
                return;
            }

            try {
                const parsed = JSON.parse(caseJson);

                const response = await fetch('/case', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(parsed)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.case_id) {
                        caseId = result.case_id;
                        localStorage.setItem('console_case_id', caseId);
                        document.getElementById('session-case-id').value = caseId;
                        document.getElementById('case-result').innerHTML =
                            `<span class="text-green-600">‚úì Case loaded</span><br>ID: ${caseId}`;
                    }
                } else {
                    const error = await response.json();
                    document.getElementById('case-result').innerHTML =
                        '<span class="text-red-600">Error: ' + JSON.stringify(error.detail || error, null, 2) + '</span>';
                }

            } catch (e) {
                document.getElementById('case-result').innerHTML =
                    '<span class="text-red-600">Error: ' + e.message + '</span>';
            }
        }

        async function startSession() {
            if (!caseId) {
                document.getElementById('session-result').innerHTML =
                    '<span class="text-red-600">Load a case first</span>';
                return;
            }

            try {
                const response = await fetch('/session', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({case_id: caseId})
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.session_id) {
                        sessionId = result.session_id;
                        localStorage.setItem('console_session_id', sessionId);
                        document.getElementById('turn-session-id').value = sessionId;
                        document.getElementById('report-session-id').value = sessionId;
                        document.getElementById('session-result').innerHTML =
                            `<span class="text-green-600">‚úì Session started</span><br>ID: ${sessionId}`;
                    }
                } else {
                    const error = await response.json();
                    document.getElementById('session-result').innerHTML =
                        '<span class="text-red-600">Error: ' + JSON.stringify(error.detail || error, null, 2) + '</span>';
                }

            } catch (e) {
                document.getElementById('session-result').innerHTML =
                    '<span class="text-red-600">Error: ' + e.message + '</span>';
            }
        }

        function updateTrustDisplay(value) {
            document.getElementById('trust-value').textContent = value;
        }

        async function turnWithMode(useVector) {
            if (!sessionId) {
                document.getElementById('turn-result').innerHTML =
                    '<span class="text-red-600">Start a session first</span>';
                return;
            }

            const utterance = document.getElementById('turn-utterance').value;
            const trust = parseFloat(document.getElementById('trust-slider').value);

            if (!utterance.trim()) {
                document.getElementById('turn-result').innerHTML =
                    '<span class="text-red-600">Enter a message first</span>';
                return;
            }

            try {
                // Set RAG mode first
                const ragResponse = await fetch('/admin/rag_mode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({use_vector: useVector})
                });

                const ragResult = await ragResponse.json();
                console.log('RAG mode set to:', ragResult);

                // Send turn request
                const turnResponse = await fetch('/turn', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        case_id: caseId,
                        session_id: sessionId,
                        therapist_utterance: utterance,
                        session_state: {
                            affect: "neutral",
                            trust: trust,
                            fatigue: 0.1,
                            access_level: 1,
                            risk_status: "none",
                            last_turn_summary: ""
                        }
                    })
                });

                if (turnResponse.ok) {
                    const turnResult = await turnResponse.json();
                    document.getElementById('turn-result').innerHTML = formatTurnResult(turnResult, useVector);
                } else {
                    const error = await turnResponse.json();
                    document.getElementById('turn-result').innerHTML =
                        '<span class="text-red-600">Turn Error: ' + JSON.stringify(error.detail || error, null, 2) + '</span>';
                }

            } catch (error) {
                document.getElementById('turn-result').innerHTML =
                    '<span class="text-red-600">Error: ' + error.message + '</span>';
            }
        }

        function riskCheck() {
            document.getElementById('turn-utterance').value = '–Ø –±–æ–ª—å—à–µ –Ω–µ —Ö–æ—á—É –∂–∏—Ç—å, —Å—É–∏—Ü–∏–¥–∞–ª—å–Ω—ã–µ –º—ã—Å–ª–∏ –º–µ–Ω—è –ø—Ä–µ—Å–ª–µ–¥—É—é—Ç';
            document.getElementById('trust-slider').value = '0.7';
            updateTrustDisplay('0.7');
        }

        async function getSessionReport() {
            if (!sessionId) {
                document.getElementById('report-result').innerHTML =
                    '<span class="text-red-600">Start a session first</span>';
                return;
            }

            try {
                const response = await fetch(`/report/session/${sessionId}`);
                const result = await response.json();
                document.getElementById('report-result').innerHTML = formatJSON(result);
            } catch (error) {
                document.getElementById('report-result').innerHTML =
                    '<span class="text-red-600">Error: ' + error.message + '</span>';
            }
        }

        function formatTurnResult(result, useVector) {
            const mode = useVector ? 'vector' : 'metadata';
            const intent = result.eval_markers?.intent || 'unknown';
            const html = `
                <div class="mb-2"><strong>Mode:</strong> <span class="text-blue-600">${mode}</span></div>
                <div class="mb-2"><strong>Patient Reply:</strong><br><span class="italic">"${result.patient_reply || 'No reply'}"</span></div>
                <div class="mb-2"><strong>Intent:</strong> ${intent}</div>
                <div class="mb-2"><strong>Risk Status:</strong> <span class="font-bold ${result.risk_status === 'acute' ? 'text-red-600' : 'text-green-600'}">${result.risk_status || 'none'}</span></div>
                <div class="mb-2"><strong>Fragments Used:</strong> ${result.used_fragments ? result.used_fragments.length : 0}</div>
                <div class="mb-2"><strong>State Updates:</strong><br><pre class="text-xs">${JSON.stringify(result.state_updates || {}, null, 2)}</pre></div>
            `;
            return html;
        }

        function formatJSON(obj) {
            return '<pre class="text-xs overflow-auto">' + JSON.stringify(obj, null, 2) + '</pre>';
        }

        // Helper functions remain as before
    </script>
</body>
</html>